<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ù…Ø¹Ù„Ù…</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <link rel="icon" href="/images/logo2.jpg" type="image/jpeg">
  <style>
    :root {
      --primary: #5B8DEE; --primary-dark: #3D5ACE; --primary-light: #E8F0FF;
      --success: #81C995; --danger: #FC8181; --warning: #F6AD55; --gray: #718096;
      --border: #E2E8F0; --light: #F7FAFC; --dark: #2D3748;
      --sidebar-width: 280px; --header-height: 70px;
      --radius-md: 12px; --radius-lg: 16px;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Tajawal',sans-serif; }
    body { 
      background:linear-gradient(135deg,#f8fafc,#e2e8f0); 
      color:var(--dark); 
      display:flex; 
      min-height:100vh; 
      overflow-x:hidden;
    }
    
    /* Mobile-first design */
    .sidebar {
      width:100%;
      background:#fff; 
      position:fixed; 
      height:100vh; 
      overflow-y:auto; 
      box-shadow:0 4px 12px rgba(0,0,0,0.08); 
      z-index:100; 
      top:0;
      right:0;
      transform:translateX(100%);
      transition:transform 0.3s ease;
      padding-top:var(--header-height);
    }
    
    .sidebar.active {
      transform:translateX(0);
    }
    
    .sidebar h3 { 
      padding:25px 20px; 
      text-align:center; 
      font-size:1.6rem; 
      font-weight:700; 
      background:var(--primary);
      color:white;
      margin:0;
    }
    
    .nav-link { 
      display:flex; 
      align-items:center; 
      padding:14px 20px; 
      color:var(--gray); 
      text-decoration:none; 
      transition:.3s; 
      border-radius:0 var(--radius-md) var(--radius-md) 0; 
    }
    
    .nav-link:hover, .nav-link.active { 
      background:var(--primary-light); 
      color:var(--primary); 
      border-right:4px solid var(--primary); 
    }
    
    .nav-link i { 
      margin-left:12px; 
      width:20px; 
    }
    
    .main-content { 
      flex:1; 
      transition:.4s; 
      width:100%;
    }
    
    .header { 
      height:var(--header-height); 
      background:#fff; 
      box-shadow:0 1px 3px rgba(0,0,0,0.1); 
      padding:0 15px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      position:sticky; 
      top:0; 
      z-index:99; 
    }
    
    .menu-toggle {
      background:none;
      border:none;
      font-size:1.5rem;
      color:var(--primary);
      cursor:pointer;
    }
    
    .content { 
      padding:20px; 
    }
    
    .card { 
      background:#fff; 
      border-radius:var(--radius-lg); 
      padding:20px; 
      box-shadow:0 2px 10px rgba(0,0,0,0.07); 
      border:1px solid var(--border); 
      margin-bottom:20px; 
    }
    
    .grid-3, .grid-4, .grid-2 { 
      display:grid; 
      grid-template-columns:1fr; 
      gap:15px; 
    }
    
    .stat-card { 
      background:#fff; 
      border-radius:var(--radius-lg); 
      padding:20px; 
      text-align:center; 
      box-shadow:0 2px 10px rgba(0,0,0,0.07); 
      position:relative; 
      overflow:hidden; 
      transition:.3s; 
    }
    
    .stat-card:hover { 
      transform:translateY(-5px); 
      box-shadow:0 8px 15px rgba(0,0,0,0.12); 
    }
    
    .stat-card::before { 
      content:''; 
      position:absolute; 
      top:0; 
      right:0; 
      width:100%; 
      height:4px; 
      background:linear-gradient(90deg,var(--primary),var(--primary-dark)); 
    }
    
    .stat-card-icon { 
      font-size:2rem; 
      color:var(--primary); 
      margin-bottom:10px; 
    }
    
    .stat-card-value { 
      font-size:1.8rem; 
      font-weight:700; 
      margin:5px 0 0; 
    }
    
    .btn { 
      padding:10px 15px; 
      border:none; 
      border-radius:var(--radius-md); 
      cursor:pointer; 
      font-weight:600; 
      display:inline-flex; 
      align-items:center; 
      gap:6px; 
      transition:.3s; 
      font-size:0.9rem;
    }
    
    .btn-primary { 
      background:linear-gradient(135deg,var(--primary),var(--primary-dark)); 
      color:#fff; 
    }
    
    .btn-primary:hover { 
      transform:translateY(-2px); 
      box-shadow:0 8px 15px rgba(91,141,238,0.3); 
    }
    
    .btn-danger { 
      background:#fc8181; 
      color:#fff; 
    }
    
    .btn-sm { 
      padding:6px 12px; 
      font-size:0.8rem; 
    }
    
    .loading { 
      text-align:center; 
      padding:40px 20px; 
    }
    
    .loading-spinner { 
      border:4px solid #f3f3f3; 
      border-top:4px solid var(--primary); 
      border-radius:50%; 
      width:40px; 
      height:40px; 
      animation:spin 1s linear infinite; 
      margin:0 auto 15px; 
    }
    
    @keyframes spin { 
      0%{transform:rotate(0)} 
      100%{transform:rotate(360deg)} 
    }
    
    .alert { 
      position:fixed; 
      top:20px; 
      right:20px; 
      padding:15px 20px; 
      border-radius:var(--radius-md); 
      color:#fff; 
      font-weight:600; 
      z-index:9999; 
      box-shadow:0 10px 20px rgba(0,0,0,0.2); 
      max-width:90%;
      font-size:0.9rem;
    }
    
    .alert-success { 
      background:#81C995; 
    }
    
    .alert-danger { 
      background:#FC8181; 
    }
    
    .alert-warning { 
      background:#F6AD55; 
    }
    
    /* Modal styles */
    .modal {
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,0.6); 
      backdrop-filter:blur(8px); 
      align-items:center; 
      justify-content:center; 
      z-index:1000;
      padding:15px;
    }
    
    .modal-content {
      background:#fff; 
      border-radius:16px; 
      width:100%; 
      max-height:90vh; 
      overflow-y:auto;
    }
    
    .modal-header {
      padding:20px; 
      border-bottom:1px solid #eee; 
      display:flex; 
      justify-content:space-between; 
      align-items:center;
    }
    
    .modal-header h2 {
      font-size:1.3rem;
      margin:0;
    }
    
    .modal-body {
      padding:20px;
    }
    
    .modal-footer {
      padding:15px 20px;
      display:flex; 
      gap:10px; 
      justify-content:flex-end;
      border-top:1px solid #eee;
    }
    
    .form-group {
      margin-bottom:15px;
    }
    
    .form-group label {
      display:block; 
      margin-bottom:5px; 
      font-weight:600;
    }
    
    .form-control {
      width:100%; 
      padding:10px; 
      border:2px solid #ddd; 
      border-radius:8px; 
      margin-top:5px;
      font-size:0.9rem;
    }
    
    .form-row {
      display:grid; 
      grid-template-columns:1fr; 
      gap:15px; 
      margin-bottom:15px;
    }
    
    /* Overlay for mobile menu */
    .overlay {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.5);
      z-index:99;
      display:none;
    }
    
    .overlay.active {
      display:block;
    }
    
    /* Responsive adjustments */
    @media (min-width: 768px) {
      .sidebar {
        width:var(--sidebar-width);
        transform:translateX(0);
        position:fixed;
        height:100vh;
        padding-top:0;
      }
      
      .main-content {
        margin-right:var(--sidebar-width);
      }
      
      .menu-toggle {
        display:none;
      }
      
      .grid-3 { 
        grid-template-columns:repeat(3,1fr); 
        gap:20px; 
      }
      
      .grid-2 { 
        grid-template-columns:repeat(2,1fr); 
        gap:20px; 
      }
      
      .stat-card-value { 
        font-size:2.2rem; 
      }
      
      .stat-card-icon { 
        font-size:2.5rem; 
      }
      
      .modal-content {
        max-width:700px;
      }
      
      .form-row {
        grid-template-columns:1fr 1fr;
      }
    }
    
    @media (min-width: 992px) {
      .grid-4 { 
        grid-template-columns:repeat(4,1fr); 
        gap:25px; 
      }
      
      .grid-3 { 
        grid-template-columns:repeat(3,1fr); 
        gap:25px; 
      }
      
      .grid-2 { 
        grid-template-columns:repeat(2,1fr); 
        gap:25px; 
      }
      
      .stat-card-value { 
        font-size:2.6rem; 
      }
      
      .stat-card-icon { 
        font-size:2.8rem; 
      }
      
      .content {
        padding:30px;
      }
      
      .card {
        padding:30px;
      }
    }
    
    /* Mobile-specific optimizations */
    @media (max-width: 767px) {
      .header {
        padding:0 10px;
      }
      
      .btn {
        padding:8px 12px;
        font-size:0.85rem;
      }
      
      .btn-sm {
        padding:5px 10px;
        font-size:0.8rem;
      }
      
      .stat-card {
        padding:15px;
      }
      
      .stat-card-icon {
        font-size:1.8rem;
      }
      
      .stat-card-value {
        font-size:1.6rem;
      }
      
      .card {
        padding:15px;
      }
      
      .content {
        padding:15px;
      }
      
      .form-row {
        grid-template-columns:1fr;
      }
      
      .modal-body {
        padding:15px;
      }
      
      .modal-header {
        padding:15px;
      }
      
      .modal-footer {
        padding:10px 15px;
      }
    }
  </style>
</head>
<body>

  <!-- Mobile menu toggle overlay -->
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h3 id="academyName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
    <ul style="list-style:none; padding:20px 0;">
      <li><a href="#" class="nav-link active" onclick="switchTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</a></li>
      <li><a href="#" class="nav-link" onclick="switchTab('profile')"><i class="fas fa-user"></i> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a></li>
      <li><a href="#" class="nav-link" onclick="switchTab('courses')"><i class="fas fa-book"></i> ÙƒÙˆØ±Ø³Ø§ØªÙŠ</a></li>
      <li><a href="#" class="nav-link" onclick="switchTab('students')"><i class="fas fa-users"></i> Ø·Ù„Ø§Ø¨ÙŠ</a></li>
      <li><a href="#" class="nav-link" onclick="switchTab('exams')"><i class="fas fa-file-alt"></i> Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªÙŠ</a></li>
      <li><a href="#" class="nav-link" onclick="switchTab('attendances')"><i class="fas fa-calendar-check"></i> Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨</a></li>
      <li><a href="#" class="nav-link" onclick="switchTab('reports')"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="header">
      <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <div style="font-size:1.2rem; font-weight:700; color:var(--primary);" id="userNameHeader">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
      <div>
        <button class="btn btn-primary btn-sm" onclick="recordCheckIn()"><i class="fas fa-sign-in-alt"></i> Ø­Ø¶ÙˆØ±</button>
        <button class="btn btn-danger btn-sm" onclick="recordCheckOut()"><i class="fas fa-sign-out-alt"></i> Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>

    <div class="content">

      <!-- Dashboard -->
      <div id="dashboardContent" style="display:block;">
        <div class="grid-3">
          <div class="stat-card"><i class="stat-card-icon fas fa-book"></i><p>Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</p><h3 id="totalCourses">0</h3></div>
          <div class="stat-card"><i class="stat-card-icon fas fa-chalkboard"></i><p>Ø§Ù„Ø¯Ø±ÙˆØ³</p><h3 id="totalLessons">0</h3></div>
          <div class="stat-card"><i class="stat-card-icon fas fa-users"></i><p>Ø§Ù„Ø·Ù„Ø§Ø¨</p><h3 id="totalStudents">0</h3></div>
        </div>
        <div class="card" style="margin-top:20px;">
          <h3 style="margin-bottom:15px;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h3>
          <canvas id="lessonsChart" height="200"></canvas>
        </div>
      </div>

      <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù…Ø®ÙÙŠØ© ÙˆØ³ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· -->
      <div id="profileContent" style="display:none;">
        <div class="card">
          <h2 style="margin-bottom:15px;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
          <div id="profileContainer" class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        </div>
      </div>
      <div id="coursesContent" style="display:none;"><div id="coursesContainer" class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div></div>
      <div id="studentsContent" style="display:none;"><div id="studentsContainer" class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div></div>
      <div id="examsContent" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h2>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
          <button class="btn btn-primary" onclick="showAddExamModal()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø±</button>
        </div>
        <div id="examsContainer" class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
      </div>
      <div id="attendancesContent" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h2>Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
          <button class="btn btn-primary" onclick="showAddAttendanceModal()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
        </div>
        <div id="attendancesContainer" class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
      </div>
      <div id="reportsContent" style="display:none;">
        <div id="reportsContainer" class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
      </div>

    </div>
  </div>

  <div id="statusMessage" class="alert" style="display:none;"></div>

  <!-- Modal Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± -->
  <div id="examModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="examModalTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø±</h2>
        <button onclick="closeModal('examModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">Ã—</button>
      </div>
      <form id="examForm">
        <div class="modal-body">
          <div class="form-group">
            <label><strong>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</strong></label>
            <input type="text" id="examTitle" required class="form-control">
          </div>
          <div class="form-group">
            <label><strong>Ø§Ù„ÙƒÙˆØ±Ø³</strong></label>
            <select id="examCourse" required class="form-control"></select>
          </div>
          <div class="form-group">
            <label><strong>Ø§Ù„ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</strong></label>
            <select id="examModule" class="form-control">
              <option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®</strong></label>
              <input type="date" id="examDate" required class="form-control">
            </div>
            <div class="form-group">
              <label><strong>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</strong></label>
              <input type="number" id="examMaxScore" value="100" min="1" required class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label><strong>Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</strong></label>
              <input type="number" id="examPassScore" value="50" min="0" step="0.1" class="form-control">
            </div>
            <div class="form-group">
              <label><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</strong></label>
              <input type="number" id="examTotalQuestions" value="0" min="0" class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label><strong>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</strong></label>
              <select id="examType" class="form-control">
                <option value="multiple_choice">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
                <option value="essay">Ù…Ù‚Ø§Ù„ÙŠ</option>
                <option value="mixed">Ù…Ø®ØªÙ„Ø·</option>
              </select>
            </div>
            <div class="form-group">
              <label><strong>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</strong></label>
              <select id="examDifficulty" class="form-control">
                <option value="easy">Ø³Ù‡Ù„</option>
                <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                <option value="hard">ØµØ¹Ø¨</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label><strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</strong></label>
            <input type="number" id="examTimeLimit" min="0" class="form-control">
          </div>
          <div class="form-group">
            <label><strong>Ø§Ù„ÙˆØµÙ</strong></label>
            <textarea id="examDescription" rows="3" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
          <button type="button" class="btn" style="background:#eee;" onclick="closeModal('examModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div id="examScoresModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="examScoresModalTitle">Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
        <button onclick="closeModal('examScoresModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="examScoresInfo" style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;"></div>
        <div id="examScoresList" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="saveExamScores()">Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
          <button class="btn" style="background:#eee;" onclick="closeModal('examScoresModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
  <div id="attendanceModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin:0; font-size:1.2em;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
        <button onclick="closeModal('attendanceModal')" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#666;">Ã—</button>
      </div>
      <form id="attendanceForm">
        <div class="modal-body">
          <div class="form-group">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Ø§Ù„ÙƒÙˆØ±Ø³</label>
            <select id="attendanceCourseFilter" required class="form-control"></select>
          </div>
          <div class="form-group">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Ø§Ù„Ø¯Ø±Ø³</label>
            <select id="attendanceLesson" required disabled class="form-control"></select>
          </div>
          <div class="form-group">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="attendanceDate" required class="form-control">
          </div>
          <div class="form-group">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <label style="margin:0; font-weight:600;">Ø§Ù„Ø·Ù„Ø§Ø¨</label>
              <button type="button" id="startQrScan" class="btn btn-primary" style="padding:6px 12px; font-size:0.85em;">
                <i class="fas fa-qrcode"></i> Ù…Ø³Ø­ QR
              </button>
              <button type="button" id="stopQrScan" class="btn btn-danger" style="padding:6px 12px; font-size:0.85em; display:none;">
                <i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù
              </button>
            </div>
            <div id="qr-reader" style="display:none; margin-bottom:10px; border:2px solid #667eea; border-radius:8px; padding:10px; background:#f9f9f9;"></div>
            <div id="studentAttendanceList" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; border-radius:6px; padding:8px; background:#fafafa;">
              <p style="text-align:center; color:#999; margin:20px 0;">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" style="background:#eee; padding:10px 20px;" onclick="closeModal('attendanceModal')">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-primary" style="padding:10px 20px;">Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://nhzbnzcdsebepsmrtona.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5oemJuemNkc2ViZXBzbXJ0b25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NjU4MTEsImV4cCI6MjA3OTI0MTgxMX0.wNSf49MpQjCCopByd3zCz4-TJ2EGGABc3-ICEsAPaFo'
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    let currentUserId = null
    let currentAcademyId = null
    let currentUserName = 'Ø§Ù„Ù…Ø¹Ù„Ù…'
    let coursesList = []
    let lessonsChart = null
    let qrScanner = null
    
    // Simple cache for teacher dashboard
    let teacherDataCache = {
      courses: { data: null, timestamp: 0 },
      students: { data: null, timestamp: 0 },
      attendances: { data: null, timestamp: 0 }
    }
    const TEACHER_CACHE_DURATION = 3 * 60 * 1000 // 3 minutes

    function showAlert(msg, type = 'success') {
      const el = document.getElementById('statusMessage')
      el.textContent = msg
      el.className = `alert alert-${type}`
      el.style.display = 'block'
      setTimeout(() => el.style.display = 'none', 4000)
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none'
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar')
      const overlay = document.getElementById('overlay')
      
      sidebar.classList.toggle('active')
      overlay.classList.toggle('active')
    }

    function switchTab(tab) {
      document.querySelectorAll('[id$="Content"]').forEach(t => t.style.display = 'none')
      document.getElementById(tab + 'Content').style.display = 'block'
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'))
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active')

      // Close sidebar on mobile after selecting a tab
      if (window.innerWidth < 768) {
        toggleSidebar()
      }

      if (tab === 'dashboard') loadDashboard()
      if (tab === 'courses') loadCourses()
      if (tab === 'students') loadStudents()
      if (tab === 'attendances') loadAttendances()
      if (tab === 'profile') loadProfile()
      if (tab === 'exams') loadExams()
      if (tab === 'reports') loadReports()
    }

    async function initApp() {
      const { data: { session } } = await supabase.auth.getSession()
      if (session?.user) {
        currentUserId = session.user.id
      } else {
        const saved = localStorage.getItem('current_academy_id')
        const savedUser = localStorage.getItem('user_id')
        if (saved && savedUser) {
          currentAcademyId = saved
          currentUserId = savedUser
        }
      }

      if (!currentUserId) {
        showAlert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'danger')
        return
      }

      // Ø¬Ù„Ø¨ academy_id Ù…Ù† profiles
      const { data: profile } = await supabase.from('profiles').select('full_name,academy_id').eq('id', currentUserId).single()
      if (profile) {
        currentAcademyId = profile.academy_id
        currentUserName = profile.full_name || 'Ø§Ù„Ù…Ø¹Ù„Ù…'
        localStorage.setItem('current_academy_id', currentAcademyId)
      }

      // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ù‚ÙÙ„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©
      if (currentAcademyId) {
        const { data: academyStatus, error: statusError } = await supabase
          .from('academy_status')
          .select('is_locked, lock_reason')
          .eq('academy_id', currentAcademyId)
          .maybeSingle()
        
        if (academyStatus && academyStatus.is_locked) {
          showAlert(`âŒ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù…ØºÙ„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ù„Ø³Ø¨Ø¨: ${academyStatus.lock_reason || 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¨Ø¨'}`, 'danger')
          console.error('ğŸš« Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù…Ù‚ÙÙˆÙ„Ø©')
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
          setTimeout(() => {
            localStorage.removeItem('user_id')
            localStorage.removeItem('current_academy_id')
            window.location.href = 'index.html'
          }, 3000)
          return
        }
      }

      document.getElementById('userNameHeader').textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUserName}`
      await loadDashboard()
    }

    async function loadDashboard() {
      if (!currentAcademyId || !currentUserId) return

      const now = Date.now()
      const cache = teacherDataCache.courses
      let myCourses = null

      // Use cache if available
      if (cache.data && (now - cache.timestamp) < TEACHER_CACHE_DURATION) {
        myCourses = cache.data
      } else {
        // Load courses once
        const { data } = await supabase.from('courses').select('id,name').eq('teacher_id', currentUserId).eq('academy_id', currentAcademyId)
        myCourses = data || []
        teacherDataCache.courses = { data: myCourses, timestamp: now }
      }

      const courseIds = myCourses?.map(c => c.id) || []
      document.getElementById('totalCourses').textContent = myCourses.length || 0

      // Load counts in parallel
      const [lessonsRes, subsRes] = await Promise.all([
        supabase.from('lessons').select('*', { count: 'exact', head: true }).in('course_id', courseIds).eq('academy_id', currentAcademyId),
        supabase.from('subscriptions').select('student_id').in('course_id', courseIds).eq('academy_id', currentAcademyId)
      ])

      document.getElementById('totalLessons').textContent = lessonsRes.count || 0
      const uniqueStudents = [...new Set(subsRes.data?.map(s => s.student_id) || [])].length
      document.getElementById('totalStudents').textContent = uniqueStudents

      // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ - use cached courses
      const labels = myCourses?.map(c => c.name) || []
      const dataCounts = await Promise.all((myCourses || []).map(async c => {
        const { count } = await supabase.from('lessons').select('*', { count: 'exact', head: true }).eq('course_id', c.id)
        return count || 0
      }))

      if (lessonsChart) lessonsChart.destroy()
      lessonsChart = new Chart(document.getElementById('lessonsChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³', data: dataCounts, backgroundColor: '#5B8DEE' }] },
        options: { 
          responsive: true, 
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      })
    }

    async function loadCourses() {
      const container = document.getElementById('coursesContainer')
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>'
      const { data } = await supabase.from('courses').select('*').eq('teacher_id', currentUserId).order('created_at', { ascending: false })
      if (!data || data.length === 0) { container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª</p>'; return }

      let html = '<div class="grid-2">'
      for (const c of data) {
        const { count: lessons } = await supabase.from('lessons').select('*', { count: 'exact', head: true }).eq('course_id', c.id)
        html += `<div class="card"><h3>${c.name}</h3><p>${c.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p><p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³:</strong> ${lessons || 0}</p></div>`
      }
      html += '</div>'
      container.innerHTML = html
    }

    async function loadStudents() {
      const container = document.getElementById('studentsContainer')
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>'
      const { data: myCourses } = await supabase.from('courses').select('id').eq('teacher_id', currentUserId)
      const courseIds = myCourses?.map(c => c.id) || []
      if (courseIds.length === 0) { container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</p>'; return }

      const { data: subs } = await supabase.from('subscriptions').select('student_id').in('course_id', courseIds)
      const studentIds = [...new Set(subs?.map(s => s.student_id) || [])]
      const { data: students } = await supabase.from('students').select('full_name,email,phone').in('id', studentIds)

      let html = '<div class="grid-2">'
      students?.forEach(s => {
        html += `<div class="card"><h3>${s.full_name}</h3><p>${s.email || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯'}</p><p>${s.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø§ØªÙ'}</p></div>`
      })
      html += '</div>'
      container.innerHTML = html || '<p style="text-align:center;color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</p>'
    }

    async function loadAttendances() {
      const container = document.getElementById('attendancesContainer')
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>'
      if (!currentAcademyId || !currentUserId) {
        container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>'
        return
      }
      
      const { data: myCourses } = await supabase.from('courses').select('id').eq('teacher_id', currentUserId).eq('academy_id', currentAcademyId)
      const courseIds = myCourses?.map(c => c.id) || []
      if (courseIds.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª</p>'
        return
      }
      
      // Ø¬Ù„Ø¨ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±
      const { data: attendances, error: attendancesError } = await supabase.from('attendances')
        .select('*')
        .eq('academy_id', currentAcademyId)
        .in('course_id', courseIds)
        .order('date', { ascending: false })
        .limit(50)
      
      if (attendancesError) {
        console.error('Attendance query error:', attendancesError)
        container.innerHTML = `<p style="text-align:center;color:#FC8181;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${attendancesError.message}</p>`
        return
      }

      if (!attendances || attendances.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±</p>'
        return
      }

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
      const studentIds = [...new Set(attendances.map(a => a.student_id).filter(Boolean))]
      const { data: students } = studentIds.length > 0 
        ? await supabase.from('students').select('id,full_name').in('id', studentIds).eq('academy_id', currentAcademyId)
        : { data: [] }
      
      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±ÙˆØ³
      const lessonIds = [...new Set(attendances.map(a => a.lesson_id).filter(Boolean))]
      const { data: lessons } = lessonIds.length > 0
        ? await supabase.from('lessons').select('id,title').in('id', lessonIds).eq('academy_id', currentAcademyId)
        : { data: [] }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±Ø§Ø¦Ø· Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
      const studentsMap = new Map(students?.map(s => [s.id, s.full_name]) || [])
      const lessonsMap = new Map(lessons?.map(l => [l.id, l.title]) || [])

      // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const enrichedData = attendances.map(a => ({
        ...a,
        studentName: studentsMap.get(a.student_id) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        lessonTitle: lessonsMap.get(a.lesson_id) || 'Ø¯Ø±Ø³'
      }))

      let html = ''
      const grouped = enrichedData.reduce((g, a) => {
        const dateKey = a.date || a.attendance_date
        g[dateKey] = g[dateKey] || []
        g[dateKey].push(a)
        return g
      }, {})

      Object.keys(grouped).sort().reverse().forEach(date => {
        const day = grouped[date]
        const present = day.filter(r => r.status === 'present').length
        const absent = day.filter(r => r.status === 'absent').length
        const late = day.filter(r => r.status === 'late').length
        html += `<div class="card" style="margin-bottom:15px;">
          <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:5px;">
            <strong>${new Date(date).toLocaleDateString('ar-EG')}</strong>
            <div style="font-size:0.9rem;">Ø­Ø§Ø¶Ø±: ${present} | ØºØ§Ø¦Ø¨: ${absent} | Ù…ØªØ£Ø®Ø±: ${late}</div>
          </div>
          <div style="display:grid; gap:8px;">`
        day.forEach(r => {
          const color = r.status === 'present' ? '#81C995' : r.status === 'absent' ? '#FC8181' : '#F6AD55'
          const label = r.status === 'present' ? 'Ø­Ø§Ø¶Ø±' : r.status === 'absent' ? 'ØºØ§Ø¦Ø¨' : 'Ù…ØªØ£Ø®Ø±'
          html += `<div style="padding:10px; background:#f8f9fa; border-radius:8px; border-right:3px solid ${color}; display:flex; justify-content:space-between; flex-wrap:wrap; gap:5px; font-size:0.9rem;">
            <span>${r.studentName}</span>
            <span>${r.lessonTitle} - <strong>${label}</strong></span>
          </div>`
        })
        html += `</div></div>`
      })
      container.innerHTML = html
    }

    async function loadProfile() {
      const container = document.getElementById('profileContainer')
      if (!container) return
      
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>'
      
      if (!currentUserId) {
        container.innerHTML = '<p style="text-align:center;color:#888;">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>'
        return
      }

      try {
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUserId)
          .single()

        if (error) throw error

        if (!profile) {
          container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>'
          return
        }

        // Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø®ÙŠØ±
        const { data: attendance } = await supabase
          .from('teacher_attendance')
          .select('*')
          .eq('teacher_id', currentUserId)
          .order('date', { ascending: false })
          .limit(5)

        let html = `
          <div style="display:grid; gap:20px;">
            <div style="background:#f8f9fa; padding:20px; border-radius:12px;">
              <h3 style="margin-bottom:15px;">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
              <div style="display:grid; gap:12px;">
                <div><strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</strong> ${profile.full_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                <div><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${profile.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                <div><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${profile.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                <div><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${profile.specialty || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                <div><strong>Ø§Ù„Ø¯ÙˆØ±:</strong> ${profile.role === 'teacher' ? 'Ù…Ø¹Ù„Ù…' : profile.role || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
              </div>
            </div>
            
            <div style="background:#f8f9fa; padding:20px; border-radius:12px;">
              <h3 style="margin-bottom:15px;">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø®ÙŠØ±</h3>
        `

        if (attendance && attendance.length > 0) {
          html += '<div style="display:grid; gap:8px;">'
          attendance.forEach(record => {
            const checkIn = record.check_in_time ? new Date(record.check_in_time).toLocaleTimeString('ar-EG') : '-'
            const checkOut = record.check_out_time ? new Date(record.check_out_time).toLocaleTimeString('ar-EG') : '-'
            html += `
              <div style="padding:12px; background:#fff; border-radius:8px; border-right:3px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; flex-wrap:wrap; gap:5px;">
                  <strong>${new Date(record.date).toLocaleDateString('ar-EG')}</strong>
                </div>
                <div style="color:#666; font-size:0.9rem;">
                  <div>Ø­Ø¶ÙˆØ±: ${checkIn}</div>
                  <div>Ø§Ù†ØµØ±Ø§Ù: ${checkOut}</div>
                </div>
              </div>
            `
          })
          html += '</div>'
        } else {
          html += '<p style="text-align:center;color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±</p>'
        }

        html += '</div></div>'
        container.innerHTML = html
      } catch (error) {
        console.error('Profile load error:', error)
        container.innerHTML = `<p style="text-align:center;color:#FC8181;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}</p>`
      }
    }

    async function showAddAttendanceModal() {
      document.getElementById('attendanceModal').style.display = 'flex'
      document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0]

      const { data: courses } = await supabase.from('courses').select('id,name').eq('teacher_id', currentUserId)
      const sel = document.getElementById('attendanceCourseFilter')
      sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option>'
      courses?.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`)
    }

    document.getElementById('attendanceCourseFilter').addEventListener('change', async function () {
      const courseId = this.value
      const lessonSel = document.getElementById('attendanceLesson')
      if (!courseId) {
        lessonSel.innerHTML = '<option>Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³ Ø£ÙˆÙ„Ø§Ù‹</option>'
        lessonSel.disabled = true
        return
      }
      const { data: lessons } = await supabase.from('lessons').select('id,title,date').eq('course_id', courseId).order('date')
      lessonSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³</option>'
      lessons?.forEach(l => {
        const d = new Date(l.date).toLocaleDateString('ar-EG')
        lessonSel.innerHTML += `<option value="${l.id}">${l.title} (${d})</option>`
      })
      lessonSel.disabled = false
    })

    document.getElementById('attendanceLesson').addEventListener('change', async function () {
      const lessonId = this.value
      const courseId = document.getElementById('attendanceCourseFilter').value
      if (!lessonId || !courseId) return

      const { data: subs } = await supabase.from('subscriptions').select('student_id').eq('course_id', courseId).eq('academy_id', currentAcademyId).eq('status', 'active')
      const studentIds = subs?.map(s => s.student_id) || []
      if (studentIds.length === 0) {
        document.getElementById('studentAttendanceList').innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ±Ø³</p>'
        return
      }
      const { data: students } = await supabase.from('students').select('id,full_name').in('id', studentIds).eq('academy_id', currentAcademyId)

      let html = ''
      students?.forEach(s => {
        html += `<div style="padding:10px; background:#fff; border-radius:6px; margin:6px 0; display:flex; justify-content:space-between; align-items:center; border:1px solid #e0e0e0;" data-student-id="${s.id}">
          <span style="font-weight:500; color:#333; font-size:0.9rem;">${s.full_name}</span>
          <select class="student-status-select" data-student-id="${s.id}" style="padding:6px 10px; border-radius:6px; border:1px solid #ddd; min-width:100px; font-size:0.9rem;">
            <option value="absent" selected>ØºØ§Ø¦Ø¨</option>
            <option value="present">Ø­Ø§Ø¶Ø±</option>
            <option value="late">Ù…ØªØ£Ø®Ø±</option>
          </select>
        </div>`
      })
      document.getElementById('studentAttendanceList').innerHTML = html || '<p style="text-align:center; color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</p>'
    })

    document.getElementById('attendanceForm').addEventListener('submit', async e => {
      e.preventDefault()
      const lessonId = document.getElementById('attendanceLesson').value
      const date = document.getElementById('attendanceDate').value
      const courseId = document.getElementById('attendanceCourseFilter').value

      const records = []
      document.querySelectorAll('#studentAttendanceList .student-status-select').forEach(select => {
        const studentId = select.getAttribute('data-student-id')
        const status = select.value
        if (studentId) {
          records.push({ 
            academy_id: currentAcademyId, 
            course_id: courseId, 
            lesson_id: lessonId, 
            student_id: studentId, 
            date, 
            status: status || 'absent' 
          })
        }
      })

      if (records.length === 0) {
        showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±', 'warning')
        return
      }

      const { error } = await supabase.from('attendances').insert(records)
      if (error) {
        console.error('Insert attendance error:', error)
        showAlert('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message, 'danger')
      } else {
        showAlert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${records.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`)
        closeModal('attendanceModal')
        loadAttendances()
      }
    })

    // QR Code Scanner Setup
    document.getElementById('startQrScan').addEventListener('click', async () => {
      const qrReader = document.getElementById('qr-reader')
      const startBtn = document.getElementById('startQrScan')
      const stopBtn = document.getElementById('stopQrScan')
      
      if (!qrReader || !startBtn || !stopBtn) return

      const lessonId = document.getElementById('attendanceLesson')?.value
      const courseId = document.getElementById('attendanceCourseFilter')?.value
      const date = document.getElementById('attendanceDate')?.value
      
      if (!lessonId || !courseId || !date) {
        showAlert('âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³ ÙˆØ§Ù„Ø¯Ø±Ø³ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… QR', 'warning')
        return
      }

      try {
        qrReader.innerHTML = ''
        qrReader.style.display = 'block'
        startBtn.style.display = 'none'
        stopBtn.style.display = 'inline-block'

        if (typeof Html5Qrcode !== 'undefined') {
          qrScanner = new Html5Qrcode('qr-reader')
          await qrScanner.start(
            { facingMode: 'environment' },
            { fps: 10, qrbox: { width: 200, height: 200 } },
            async (decodedText) => {
              try {
                const studentData = JSON.parse(decodedText)
                const scannedStudentId = studentData.student_id

                if (!scannedStudentId) {
                  showAlert('âš ï¸ QR Code ØºÙŠØ± ØµØ§Ù„Ø­', 'warning')
                  return
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                const statusSelect = document.querySelector(`#studentAttendanceList .student-status-select[data-student-id="${scannedStudentId}"]`)
                if (!statusSelect) {
                  showAlert('âš ï¸ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³', 'warning')
                  return
                }

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Ø­Ø§Ø¶Ø±
                const studentDiv = statusSelect.closest('div[data-student-id]')
                const studentName = studentDiv.querySelector('span').textContent.trim()
                
                statusSelect.value = 'present'
                
                // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
                studentDiv.style.background = '#c8e6c9'
                studentDiv.style.borderColor = '#4caf50'
                setTimeout(() => {
                  studentDiv.style.background = '#fff'
                  studentDiv.style.borderColor = '#e0e0e0'
                }, 1500)
                
                showAlert(`âœ… ${studentName} - Ø­Ø§Ø¶Ø±`, 'success')
              } catch (e) {
                console.error('Error parsing QR:', e)
                showAlert('âš ï¸ QR Code ØºÙŠØ± ØµØ§Ù„Ø­', 'warning')
              }
            },
            (errorMessage) => {
              // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
            }
          )
        } else {
          showAlert('Ù…ÙƒØªØ¨Ø© QR Scanner ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©', 'danger')
        }
      } catch (error) {
        console.error('QR Scanner error:', error)
        showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + error.message, 'danger')
        qrReader.style.display = 'none'
        startBtn.style.display = 'inline-block'
        stopBtn.style.display = 'none'
      }
    })

    document.getElementById('stopQrScan').addEventListener('click', async () => {
      const qrReader = document.getElementById('qr-reader')
      const startBtn = document.getElementById('startQrScan')
      const stopBtn = document.getElementById('stopQrScan')
      
      if (qrScanner) {
        try {
          await qrScanner.stop()
          qrScanner.clear()
          qrScanner = null
        } catch (error) {
          console.error('Error stopping scanner:', error)
        }
      }
      
      if (qrReader) qrReader.style.display = 'none'
      if (startBtn) startBtn.style.display = 'inline-block'
      if (stopBtn) stopBtn.style.display = 'none'
    })

    async function recordCheckIn() {
      const today = new Date().toISOString().slice(0,10)
      const now = new Date().toISOString()
      const { data } = await supabase.from('teacher_attendance').select('id').eq('teacher_id', currentUserId).eq('date', today).single()
      if (data) return showAlert('Ø³Ø¬Ù„Øª Ø­Ø¶ÙˆØ±Ùƒ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„', 'warning')

      const { error } = await supabase.from('teacher_attendance').insert({
        teacher_id: currentUserId,
        academy_id: currentAcademyId,
        date: today,
        check_in_time: now
      })
      error ? showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±', 'danger') : showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­')
    }

    async function recordCheckOut() {
      const today = new Date().toISOString().slice(0,10)
      const now = new Date().toISOString()
      const { data } = await supabase.from('teacher_attendance').select('id,check_out_time').eq('teacher_id', currentUserId).eq('date', today).single()
      if (!data) return showAlert('Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹', 'warning')
      if (data.check_out_time) return showAlert('Ø³Ø¬Ù„Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„', 'warning')

      const { error } = await supabase.from('teacher_attendance').update({ check_out_time: now }).eq('id', data.id)
      error ? showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù', 'danger') : showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø¨Ù†Ø¬Ø§Ø­')
    }

    let currentExamId = null
    let examScoresData = []

    async function loadExams() {
      const container = document.getElementById('examsContainer')
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>'
      
      if (!currentAcademyId || !currentUserId) {
        container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>'
        return
      }

      const { data: myCourses } = await supabase.from('courses').select('id,name').eq('teacher_id', currentUserId).eq('academy_id', currentAcademyId)
      const courseIds = myCourses?.map(c => c.id) || []
      
      if (courseIds.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª</p>'
        return
      }

      const { data: exams, error } = await supabase
        .from('exams')
        .select('*')
        .eq('academy_id', currentAcademyId)
        .in('course_id', courseIds)
        .order('date', { ascending: false })

      if (error) {
        console.error('Exams query error:', error)
        container.innerHTML = `<p style="text-align:center;color:#FC8181;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}</p>`
        return
      }

      if (!exams || exams.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</p>'
        return
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª
      const coursesMap = new Map(myCourses.map(c => [c.id, c.name]))

      let html = '<div class="grid-2">'
      exams.forEach(exam => {
        const courseName = coursesMap.get(exam.course_id) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
        const examTypeText = exam.exam_type === 'multiple_choice' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 
                           exam.exam_type === 'essay' ? 'Ù…Ù‚Ø§Ù„ÙŠ' : 
                           exam.exam_type === 'mixed' ? 'Ù…Ø®ØªÙ„Ø·' : exam.exam_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
        const difficultyText = exam.difficulty_level === 'easy' ? 'Ø³Ù‡Ù„' :
                              exam.difficulty_level === 'medium' ? 'Ù…ØªÙˆØ³Ø·' :
                              exam.difficulty_level === 'hard' ? 'ØµØ¹Ø¨' : exam.difficulty_level || 'Ù…ØªÙˆØ³Ø·'
        
        html += `
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
              <h3 style="margin:0; font-size:1.1rem;">${exam.title}</h3>
              <div style="display:flex; gap:5px;">
                <button class="btn btn-sm" style="background:#5B8DEE; color:#fff; padding:5px 10px;" onclick="editExam(${exam.id})" title="ØªØ¹Ø¯ÙŠÙ„">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm" style="background:#FC8181; color:#fff; padding:5px 10px;" onclick="deleteExam(${exam.id})" title="Ø­Ø°Ù">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <p style="font-size:0.9rem;"><strong>Ø§Ù„ÙƒÙˆØ±Ø³:</strong> ${courseName}</p>
            <p style="font-size:0.9rem;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${exam.date ? new Date(exam.date).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            <p style="font-size:0.9rem;"><strong>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©:</strong> ${exam.max_score}</p>
            <p style="font-size:0.9rem;"><strong>Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¬Ø§Ø­:</strong> ${exam.pass_score || 0}</p>
            <p style="font-size:0.9rem;"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</strong> ${exam.total_questions || 0}</p>
            <p style="font-size:0.9rem;"><strong>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> ${examTypeText}</p>
            <p style="font-size:0.9rem;"><strong>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©:</strong> ${difficultyText}</p>
            ${exam.time_limit ? `<p style="font-size:0.9rem;"><strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯:</strong> ${exam.time_limit} Ø¯Ù‚ÙŠÙ‚Ø©</p>` : ''}
            ${exam.description ? `<p style="font-size:0.9rem;"><strong>Ø§Ù„ÙˆØµÙ:</strong> ${exam.description}</p>` : ''}
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" onclick="showExamScoresModal(${exam.id})" style="font-size:0.85rem;">
                <i class="fas fa-graduation-cap"></i> Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
              </button>
              <button class="btn btn-sm" style="background:#81C995; color:#fff; font-size:0.85rem;" onclick="viewExamScores(${exam.id})">
                <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
              </button>
            </div>
          </div>
        `
      })
      html += '</div>'
      container.innerHTML = html
    }

    async function showAddExamModal() {
      currentExamId = null
      document.getElementById('examModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø±'
      document.getElementById('examForm').reset()
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
      const { data: courses } = await supabase
        .from('courses')
        .select('id,name')
        .eq('teacher_id', currentUserId)
        .eq('academy_id', currentAcademyId)
        .order('name')
      
      const courseSelect = document.getElementById('examCourse')
      courseSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option>'
      courses?.forEach(c => {
        courseSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`
      })

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ­Ø¯Ø§Øª
      document.getElementById('examModule').innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>'
      
      document.getElementById('examModal').style.display = 'flex'
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙˆØ±Ø³
    document.addEventListener('DOMContentLoaded', () => {
      const examCourseSelect = document.getElementById('examCourse')
      if (examCourseSelect) {
        examCourseSelect.addEventListener('change', async function() {
          const courseId = this.value
          const moduleSelect = document.getElementById('examModule')
          
          if (!courseId) {
            moduleSelect.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>'
            return
          }

          const { data: modules } = await supabase
            .from('modules')
            .select('id,title')
            .eq('course_id', courseId)
            .eq('academy_id', currentAcademyId)
            .order('order')

          moduleSelect.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>'
          modules?.forEach(m => {
            moduleSelect.innerHTML += `<option value="${m.id}">${m.title}</option>`
          })
        })
      }
    })

    async function editExam(examId) {
      currentExamId = examId
      document.getElementById('examModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±'
      
      const { data: exam, error } = await supabase
        .from('exams')
        .select('*')
        .eq('id', examId)
        .single()

      if (error || !exam) {
        showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'danger')
        return
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
      const { data: courses } = await supabase
        .from('courses')
        .select('id,name')
        .eq('teacher_id', currentUserId)
        .eq('academy_id', currentAcademyId)

      const courseSelect = document.getElementById('examCourse')
      courseSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option>'
      courses?.forEach(c => {
        courseSelect.innerHTML += `<option value="${c.id}" ${c.id === exam.course_id ? 'selected' : ''}>${c.name}</option>`
      })

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
      if (exam.course_id) {
        const { data: modules } = await supabase
          .from('modules')
          .select('id,title')
          .eq('course_id', exam.course_id)
          .eq('academy_id', currentAcademyId)
          .order('order')

        const moduleSelect = document.getElementById('examModule')
        moduleSelect.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>'
        modules?.forEach(m => {
          moduleSelect.innerHTML += `<option value="${m.id}" ${m.id === exam.module_id ? 'selected' : ''}>${m.title}</option>`
        })
      }

      // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
      document.getElementById('examTitle').value = exam.title || ''
      document.getElementById('examDate').value = exam.date || ''
      document.getElementById('examMaxScore').value = exam.max_score || 100
      document.getElementById('examPassScore').value = exam.pass_score || 50
      document.getElementById('examTotalQuestions').value = exam.total_questions || 0
      document.getElementById('examType').value = exam.exam_type || 'multiple_choice'
      document.getElementById('examDifficulty').value = exam.difficulty_level || 'medium'
      document.getElementById('examTimeLimit').value = exam.time_limit || ''
      document.getElementById('examDescription').value = exam.description || ''

      document.getElementById('examModal').style.display = 'flex'
    }

    async function deleteExam(examId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) return

      const { error } = await supabase
        .from('exams')
        .delete()
        .eq('id', examId)
        .eq('academy_id', currentAcademyId)

      if (error) {
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message, 'danger')
      } else {
        showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­')
        loadExams()
      }
    }

    document.getElementById('examForm').addEventListener('submit', async e => {
      e.preventDefault()
      
      const examData = {
        academy_id: currentAcademyId,
        course_id: document.getElementById('examCourse').value,
        title: document.getElementById('examTitle').value,
        date: document.getElementById('examDate').value,
        max_score: parseInt(document.getElementById('examMaxScore').value),
        pass_score: parseFloat(document.getElementById('examPassScore').value) || 0,
        total_questions: parseInt(document.getElementById('examTotalQuestions').value) || 0,
        exam_type: document.getElementById('examType').value,
        difficulty_level: document.getElementById('examDifficulty').value,
        description: document.getElementById('examDescription').value,
        created_by: currentUserId
      }

      const moduleId = document.getElementById('examModule').value
      if (moduleId) examData.module_id = moduleId

      const timeLimit = document.getElementById('examTimeLimit').value
      if (timeLimit) examData.time_limit = parseInt(timeLimit)

      let error
      if (currentExamId) {
        // ØªØ­Ø¯ÙŠØ«
        const { error: updateError } = await supabase
          .from('exams')
          .update(examData)
          .eq('id', currentExamId)
          .eq('academy_id', currentAcademyId)
        error = updateError
      } else {
        // Ø¥Ø¶Ø§ÙØ©
        const { error: insertError } = await supabase
          .from('exams')
          .insert(examData)
        error = insertError
      }

      if (error) {
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message, 'danger')
        console.error('Exam save error:', error)
      } else {
        showAlert(currentExamId ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­')
        closeModal('examModal')
        loadExams()
      }
    })

    async function showExamScoresModal(examId) {
      currentExamId = examId
      examScoresData = []

      const { data: exam, error: examError } = await supabase
        .from('exams')
        .select('*, courses(name)')
        .eq('id', examId)
        .single()

      if (examError || !exam) {
        showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'danger')
        return
      }

      // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ±Ø³
      const { data: course } = await supabase
        .from('courses')
        .select('name')
        .eq('id', exam.course_id)
        .single()

      document.getElementById('examScoresModalTitle').textContent = `Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø§Øª: ${exam.title}`
      document.getElementById('examScoresInfo').innerHTML = `
        <div style="font-size:0.9rem;"><strong>Ø§Ù„ÙƒÙˆØ±Ø³:</strong> ${course?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
        <div style="font-size:0.9rem;"><strong>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©:</strong> ${exam.max_score}</div>
        <div style="font-size:0.9rem;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${exam.date ? new Date(exam.date).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
      `

      // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„ÙƒÙˆØ±Ø³
      const { data: subs } = await supabase
        .from('subscriptions')
        .select('student_id')
        .eq('course_id', exam.course_id)
        .eq('academy_id', currentAcademyId)
        .eq('status', 'active')

      const studentIds = subs?.map(s => s.student_id) || []
      
      if (studentIds.length === 0) {
        document.getElementById('examScoresList').innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ±Ø³</p>'
        document.getElementById('examScoresModal').style.display = 'flex'
        return
      }

      const { data: students } = await supabase
        .from('students')
        .select('id,full_name,email')
        .in('id', studentIds)
        .eq('academy_id', currentAcademyId)

      // Ù…Ù„Ø§Ø­Ø¸Ø©: exam_scores.student_id ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ users.id
      // Ø³Ù†Ø³ØªØ®Ø¯Ù… students.id Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙ†Ø­Ø§ÙˆÙ„ØŒ ÙˆØ¥Ø°Ø§ ÙØ´Ù„ Ø³Ù†Ø³ØªØ®Ø¯Ù… profiles
      let profilesMap = new Map()
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ profiles Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø§Ø¨
      const studentEmails = students?.map(s => s.email).filter(Boolean) || []
      if (studentEmails.length > 0) {
        const { data: profiles } = await supabase
          .from('profiles')
          .select('id,email')
          .in('email', studentEmails)
          .eq('academy_id', currentAcademyId)
        
        profiles?.forEach(p => {
          const student = students.find(s => s.email === p.email)
          if (student) {
            profilesMap.set(student.id, p.id)
          }
        })
      }

      // Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… profilesØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… students.id Ù…Ø¨Ø§Ø´Ø±Ø©
      // (Ø¹Ù„Ù‰ Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† students.id = users.id ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
      students?.forEach(student => {
        if (!profilesMap.has(student.id)) {
          profilesMap.set(student.id, student.id)
        }
      })

      // Ø¬Ù„Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
      const { data: existingScores } = await supabase
        .from('exam_scores')
        .select('*')
        .eq('exam_id', examId)
        .eq('academy_id', currentAcademyId)

      const scoresMap = new Map(existingScores?.map(s => [s.student_id, s]) || [])

      let html = '<div style="display:grid; gap:8px;">'
      students?.forEach(student => {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… profile_id Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… student.id
        const userId = profilesMap.get(student.id) || student.id
        const existing = scoresMap.get(userId)
        const score = existing?.score || ''
        const examDate = existing?.exam_date || exam.date || new Date().toISOString().split('T')[0]
        
        examScoresData.push({
          student_id: userId, // Ø§Ø³ØªØ®Ø¯Ø§Ù… profile_id Ø£Ùˆ user_id
          student_original_id: student.id, // Ø­ÙØ¸ ID Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¹Ø±Ø¶
          student_name: student.full_name,
          score: score,
          exam_date: examDate,
          existing_id: existing?.id
        })

        html += `
          <div style="padding:12px; background:#f8f9fa; border-radius:8px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <div style="font-size:0.9rem;"><strong>${student.full_name}</strong></div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <label style="font-size:0.9rem;">Ø§Ù„Ø¯Ø±Ø¬Ø©:</label>
              <input type="number" 
                     data-student-id="${student.id}" 
                     value="${score}" 
                     min="0" 
                     max="${exam.max_score}" 
                     step="0.1"
                     style="width:80px; padding:6px; border:2px solid #ddd; border-radius:6px; font-size:0.9rem;"
                     onchange="updateExamScore('${student.id}', this.value)">
              <span style="font-size:0.9rem;">/ ${exam.max_score}</span>
            </div>
          </div>
        `
      })
      html += '</div>'
      document.getElementById('examScoresList').innerHTML = html
      document.getElementById('examScoresModal').style.display = 'flex'
    }

    function updateExamScore(studentId, score) {
      // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… student_original_id Ø£Ùˆ student_id
      const item = examScoresData.find(s => 
        s.student_original_id === studentId || s.student_id === studentId
      )
      if (item) {
        item.score = score ? parseFloat(score) : null
      }
    }

    async function saveExamScores() {
      if (!currentExamId) return

      // âš ï¸ ØªØ­Ø°ÙŠØ± Ù…Ù‡Ù…: ÙŠØ¬Ø¨ ØªØ·Ø¨ÙŠÙ‚ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹!
      // Ø±Ø§Ø¬Ø¹ Ù…Ù„Ù APPLY_THIS_FIX.sql ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡ ÙÙŠ Supabase SQL Editor
      const { data: exam } = await supabase
        .from('exams')
        .select('*')
        .eq('id', currentExamId)
        .single()

      if (!exam) {
        showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'danger')
        return
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ student_id Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ students
      const allStudentIds = examScoresData
        .filter(item => item.score !== null && item.score !== '')
        .map(item => item.student_original_id || item.student_id)
        .filter(Boolean)
      
      if (allStudentIds.length === 0) {
        showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning')
        return
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø¬Ø¯ÙˆÙ„ students
      const { data: validStudents, error: studentsCheckError } = await supabase
        .from('students')
        .select('id')
        .in('id', allStudentIds)
        .eq('academy_id', currentAcademyId)

      if (studentsCheckError) {
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨: ' + studentsCheckError.message, 'danger')
        console.error('Students check error:', studentsCheckError)
        return
      }

      const validStudentIdsSet = new Set(validStudents?.map(s => s.id) || [])
      const missingStudents = allStudentIds.filter(id => !validStudentIdsSet.has(id))
      
      if (missingStudents.length > 0) {
        showAlert(
          `Ø®Ø·Ø£: ${missingStudents.length} Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø¬Ø¯ÙˆÙ„ students:\n` +
          `${missingStudents.slice(0, 3).join(', ')}${missingStudents.length > 3 ? '...' : ''}\n\n` +
          `ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø¬Ø¯ÙˆÙ„ students Ø£ÙˆÙ„Ø§Ù‹.`,
          'danger'
        )
        console.error('Missing students:', missingStudents)
        return
      }

      // Ø§Ù„Ø¢Ù† Ù†Ø³ØªØ®Ø¯Ù… student_original_id (Ù…Ù† students) Ù…Ø¨Ø§Ø´Ø±Ø©
      // Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø³ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­

      const recordsToInsert = []
      const recordsToUpdate = []

      examScoresData.forEach(item => {
        if (item.score === null || item.score === '' || !item.student_id) return

        const scoreValue = parseFloat(item.score)
        if (isNaN(scoreValue) || scoreValue < 0) {
          console.warn('Invalid score value:', item.score)
          return
        }

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… student_original_id (Ù…Ù† students) Ù…Ø¨Ø§Ø´Ø±Ø©
        // Ø¨Ø¹Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø³ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
        const studentIdToUse = item.student_original_id || item.student_id

        const record = {
          academy_id: currentAcademyId,
          exam_id: parseInt(currentExamId), // exam_id Ù‡Ùˆ integer
          student_id: studentIdToUse, // Ø§Ø³ØªØ®Ø¯Ø§Ù… students.id Ù…Ø¨Ø§Ø´Ø±Ø©
          score: scoreValue,
          exam_date: item.exam_date || exam.date || new Date().toISOString().split('T')[0]
        }

        if (item.existing_id) {
          recordsToUpdate.push({ id: item.existing_id, ...record })
        } else {
          recordsToInsert.push(record)
        }
      })

      if (recordsToInsert.length === 0 && recordsToUpdate.length === 0) {
        showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§', 'warning')
        return
      }

      let error = null
      let savedCount = 0

      // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ø­Ø¯Ø§Ù‹ ØªÙ„Ùˆ Ø§Ù„Ø¢Ø®Ø± Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù€ conflict
      if (recordsToInsert.length > 0) {
        for (const record of recordsToInsert) {
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬
          const { error: insertError } = await supabase
            .from('exam_scores')
            .insert(record)
          
          if (insertError) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ø¨Ø³Ø¨Ø¨ foreign key constraint (23503)
            // ÙŠØ¹Ù†ÙŠ Ø£Ù† student_id ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ users (Ù‚Ø¨Ù„ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            // Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ students (Ø¨Ø¹Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            if (insertError.code === '23503') {
              const studentOriginalId = examScoresData.find(s => 
                s.student_id === record.student_id || s.student_original_id === record.student_id
              )?.student_original_id
              
              console.warn('Foreign key error - student not found:', {
                student_id_used: record.student_id,
                original_id: studentOriginalId,
                error: insertError.message
              })
              
              // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† profile Ø¨Ø¯ÙŠÙ„ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
              if (studentOriginalId) {
                try {
                  const { data: student } = await supabase
                    .from('students')
                    .select('id,email')
                    .eq('id', studentOriginalId)
                    .eq('academy_id', currentAcademyId)
                    .maybeSingle()
                  
                  if (student?.email) {
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† profile Ø¨Ø¯ÙˆÙ† .single() Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ 406
                    const { data: profiles } = await supabase
                      .from('profiles')
                      .select('id')
                      .eq('email', student.email)
                      .eq('academy_id', currentAcademyId)
                      .limit(1)
                    
                    if (profiles && profiles.length > 0) {
                      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ profile.id
                      const retryRecord = { ...record, student_id: profiles[0].id }
                      const { error: retryError } = await supabase
                        .from('exam_scores')
                        .insert(retryRecord)
                      
                      if (!retryError) {
                        savedCount++
                        continue
                      }
                    }
                  }
                } catch (profileError) {
                  console.warn('Error searching for profile:', profileError)
                }
              }
              
              // Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§ØªØŒ ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„
              // ÙˆØ£Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø£Ù†Ù‡ ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              console.warn('Skipping student record:', record.student_id)
              continue // ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ø¨Ø³Ø¨Ø¨ duplicateØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ
            if (insertError.code === '23505' || insertError.message.includes('duplicate')) {
              // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
              const { data: existing } = await supabase
                .from('exam_scores')
                .select('id')
                .eq('exam_id', record.exam_id)
                .eq('student_id', record.student_id)
                .eq('academy_id', record.academy_id)
                .single()
              
              if (existing) {
                const { error: updateError } = await supabase
                  .from('exam_scores')
                  .update({ score: record.score, exam_date: record.exam_date })
                  .eq('id', existing.id)
                
                if (!updateError) {
                  savedCount++
                  continue
                }
              }
            }
            error = insertError
            console.error('Insert error for record:', record, insertError)
            break
          } else {
            savedCount++
          }
        }
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
      if (!error && recordsToUpdate.length > 0) {
        for (const record of recordsToUpdate) {
          const { id, ...updateData } = record
          
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… student_original_id Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ¶Ø§Ù‹
          if (updateData.student_id) {
            const item = examScoresData.find(s => 
              s.student_id === updateData.student_id || 
              s.existing_id === id
            )
            if (item?.student_original_id) {
              updateData.student_id = item.student_original_id
            }
          }
          
          const { error: updateError } = await supabase
            .from('exam_scores')
            .update(updateData)
            .eq('id', id)
          if (updateError) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ø¨Ø³Ø¨Ø¨ foreign keyØŒ ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„
            if (updateError.code === '23503') {
              console.warn('Skipping update - foreign key error:', record.student_id, updateError)
              continue
            }
            error = updateError
            console.error('Update error for record:', record, updateError)
            break
          } else {
            savedCount++
          }
        }
      }

      // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ®Ø·Ø§Ø©
      const skippedCount = recordsToInsert.length - savedCount
      
      if (error && error.code !== '23503') {
        // Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªØ¹Ù„Ù‚ Ø¨Ù€ foreign key
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: ' + error.message, 'danger')
        console.error('Save scores error:', error)
      } else {
        if (savedCount > 0) {
          let message = `ØªÙ… Ø­ÙØ¸ ${savedCount} Ø¯Ø±Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­`
          if (skippedCount > 0) {
            message += `. ØªÙ… ØªØ®Ø·ÙŠ ${skippedCount} Ø·Ø§Ù„Ø¨ (ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ users/students)`
            showAlert(message, 'warning')
          } else {
            showAlert(message)
          }
          closeModal('examScoresModal')
          loadExams() // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        } else {
          if (skippedCount > 0) {
            showAlert(
              `âŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø¯Ø±Ø¬Ø§Øª!\n\n` +
              `Ø§Ù„Ø³Ø¨Ø¨: Foreign Key ÙÙŠ Ø¬Ø¯ÙˆÙ„ exam_scores ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ users.id ÙˆÙ„ÙŠØ³ students.id\n\n` +
              `Ø§Ù„Ø­Ù„: ÙŠØ¬Ø¨ ØªØ·Ø¨ÙŠÙ‚ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹:\n` +
              `1. Ø§ÙØªØ­ Supabase Dashboard â†’ SQL Editor\n` +
              `2. Ø´ØºÙ‘Ù„ Ù…Ø­ØªÙˆÙ‰ Ù…Ù„Ù: fix_exam_scores_foreign_key.sql\n` +
              `3. Ø¬Ø±Ø¨ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰\n\n` +
              `Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø«Ø±ÙŠÙ†: ${skippedCount}`,
              'danger'
            )
          } else {
            showAlert('Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø¯Ø±Ø¬Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'warning')
          }
        }
      }
    }

    async function viewExamScores(examId) {
      const { data: exam } = await supabase
        .from('exams')
        .select('*')
        .eq('id', examId)
        .single()

      if (!exam) {
        showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'danger')
        return
      }

      const { data: scores } = await supabase
        .from('exam_scores')
        .select('*')
        .eq('exam_id', examId)
        .eq('academy_id', currentAcademyId)

      if (!scores || scores.length === 0) {
        showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'warning')
        return
      }

      const studentIds = [...new Set(scores.map(s => s.student_id))]
      const { data: students } = await supabase
        .from('students')
        .select('id,full_name')
        .in('id', studentIds)
        .eq('academy_id', currentAcademyId)

      const studentsMap = new Map(students?.map(s => [s.id, s.full_name]) || [])

      let html = `
        <div class="card">
          <h3 style="margin-bottom:15px; font-size:1.2rem;">Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - ${exam.title}</h3>
          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
              <thead>
                <tr style="background:#f8f9fa;">
                  <th style="padding:10px; text-align:right; border:1px solid #ddd;">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                  <th style="padding:10px; text-align:center; border:1px solid #ddd;">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                  <th style="padding:10px; text-align:center; border:1px solid #ddd;">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                  <th style="padding:10px; text-align:center; border:1px solid #ddd;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody>
      `

      scores.forEach(score => {
        const studentName = studentsMap.get(score.student_id) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
        const percentage = ((score.score / exam.max_score) * 100).toFixed(1)
        const passed = score.score >= exam.pass_score
        const statusColor = passed ? '#81C995' : '#FC8181'
        const statusText = passed ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨'

        html += `
          <tr>
            <td style="padding:10px; border:1px solid #ddd;">${studentName}</td>
            <td style="padding:10px; text-align:center; border:1px solid #ddd;">${score.score} / ${exam.max_score}</td>
            <td style="padding:10px; text-align:center; border:1px solid #ddd;">${percentage}%</td>
            <td style="padding:10px; text-align:center; border:1px solid #ddd; color:${statusColor}; font-weight:bold;">${statusText}</td>
          </tr>
        `
      })

      html += `
              </tbody>
            </table>
          </div>
        </div>
      `

      // Ø¥Ù†Ø´Ø§Ø¡ modal Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
      const modal = document.createElement('div')
      modal.className = 'modal'
      modal.style.cssText = 'display:flex; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); align-items:center; justify-content:center; z-index:1000; padding:15px;'
      modal.innerHTML = `
        <div style="background:#fff; border-radius:16px; width:100%; max-width:900px; max-height:90vh; overflow-y:auto;">
          <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="font-size:1.3rem; margin:0;">Ø¹Ø±Ø¶ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
            <button onclick="this.closest('.modal').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">Ã—</button>
          </div>
          <div style="padding:20px;">
            ${html}
          </div>
        </div>
      `
      document.body.appendChild(modal)
    }

    async function loadReports() {
      const container = document.getElementById('reportsContainer')
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>'
      
      if (!currentAcademyId || !currentUserId) {
        container.innerHTML = '<p style="text-align:center;color:#888;">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>'
        return
      }

      try {
        const { data: myCourses } = await supabase.from('courses').select('id,name').eq('teacher_id', currentUserId).eq('academy_id', currentAcademyId)
        const courseIds = myCourses?.map(c => c.id) || []

        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ±
        const { data: attendanceData } = await supabase
          .from('attendances')
          .select('status')
          .eq('academy_id', currentAcademyId)
          .in('course_id', courseIds)

        const presentCount = attendanceData?.filter(a => a.status === 'present').length || 0
        const absentCount = attendanceData?.filter(a => a.status === 'absent').length || 0
        const lateCount = attendanceData?.filter(a => a.status === 'late').length || 0
        const totalAttendance = attendanceData?.length || 0

        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        const { data: myExams } = await supabase
          .from('exams')
          .select('id')
          .eq('academy_id', currentAcademyId)
          .in('course_id', courseIds)
        const examIds = myExams?.map(e => e.id) || []
        
        const { data: examScores } = examIds.length > 0 ? await supabase
          .from('exam_scores')
          .select('score')
          .eq('academy_id', currentAcademyId)
          .in('exam_id', examIds) : { data: [] }

        const avgScore = examScores && examScores.length > 0
          ? (examScores.reduce((sum, e) => sum + (parseFloat(e.score) || 0), 0) / examScores.length).toFixed(2)
          : 0

        let html = `
          <div class="grid-3" style="margin-bottom:20px;">
            <div class="stat-card">
              <i class="stat-card-icon fas fa-check-circle"></i>
              <p>Ø§Ù„Ø­Ø¶ÙˆØ±</p>
              <h3 class="stat-card-value">${presentCount}</h3>
            </div>
            <div class="stat-card">
              <i class="stat-card-icon fas fa-times-circle"></i>
              <p>Ø§Ù„ØºÙŠØ§Ø¨</p>
              <h3 class="stat-card-value">${absentCount}</h3>
            </div>
            <div class="stat-card">
              <i class="stat-card-icon fas fa-clock"></i>
              <p>Ø§Ù„ØªØ£Ø®ÙŠØ±</p>
              <h3 class="stat-card-value">${lateCount}</h3>
            </div>
          </div>
          <div class="card">
            <h3 style="margin-bottom:15px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
            <div style="display:grid; gap:12px; font-size:0.9rem;">
              <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±:</strong> ${totalAttendance}</div>
              <div><strong>Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±:</strong> ${totalAttendance > 0 ? ((presentCount / totalAttendance) * 100).toFixed(1) : 0}%</div>
              <div><strong>Ù…ØªÙˆØ³Ø· Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:</strong> ${avgScore}</div>
              <div><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª:</strong> ${myCourses?.length || 0}</div>
            </div>
          </div>
        `
        container.innerHTML = html
      } catch (error) {
        console.error('Reports load error:', error)
        container.innerHTML = `<p style="text-align:center;color:#FC8181;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}</p>`
      }
    }

    document.addEventListener('DOMContentLoaded', initApp)
  </script>
</body>
</html>
